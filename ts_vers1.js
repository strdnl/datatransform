//TO TEST (requires input in Uint8Array format)
//encode(input) - returns 'res'
//decode(input) - returns 'ret'
//tinp(length) sets up a random test array 'inp'.

// Hence to test:
//tinp(512);encode(inp);decode(res);ret.join("")==inp.join("");


ixx=[255,1,254,2,253,3,252,4,251,5,250,6,249,7,248,8,247,9,246,10,245,11,244,12,243,13,242,14,241,15,240,16,239,17,238,18,237,19,236,20,235,21,234,22,233,23,232,24,231,25,230,26,229,27,228,28,227,29,226,30,225,31,224,32,223,33,222,34,221,35,220,36,219,37,218,38,217,39,216,40,215,41,214,42,213,43,212,44,211,45,210,46,209,47,208,48,207,49,206,50,205,51,204,52,203,53,202,54,201,55,200,56,199,57,198,58,197,59,196,60,195,61,194,62,193,63,192,64,191,65,190,66,189,67,188,68,187,69,186,70,185,71,184,72,183,73,182,74,181,75,180,76,179,77,178,78,177,79,176,80,175,81,174,82,173,83,172,84,171,85,170,86,169,87,168,88,167,89,166,90,165,91,164,92,163,93,162,94,161,95,160,96,159,97,158,98,157,99,156,100,155,101,154,102,153,103,152,104,151,105,150,106,149,107,148,108,147,109,146,110,145,111,144,112,143,113,142,114,141,115,140,116,139,117,138,118,137,119,136,120,135,121,134,122,133,123,132,124,131,125,130,126,129,127,128,0];
ixx2=[82,9,106,213,48,54,165,56,191,64,163,158,129,243,215,251,124,227,57,130,155,47,255,135,52,142,67,68,196,222,233,203,84,123,148,50,166,194,35,61,238,76,149,11,66,250,195,78,8,46,161,102,40,217,36,178,118,91,162,73,109,139,209,37,114,248,246,100,134,104,152,22,212,164,92,204,93,101,182,146,108,112,72,80,253,237,185,218,94,21,70,87,167,141,157,132,144,216,171,0,140,188,211,10,247,228,88,5,184,179,69,6,208,44,30,143,202,63,15,2,193,175,189,3,1,19,138,107,58,145,17,65,79,103,220,234,151,242,207,206,240,180,230,115,150,172,116,34,231,173,53,133,226,249,55,232,28,117,223,110,71,241,26,113,29,41,197,137,111,183,98,14,170,24,190,27,252,86,62,75,198,210,121,32,154,219,192,254,120,205,90,244,31,221,168,51,136,7,199,49,177,18,16,89,39,128,236,95,96,81,127,169,25,181,74,13,45,229,122,159,147,201,156,239,160,224,59,77,174,42,245,176,200,235,187,60,131,83,153,97,23,43,4,126,186,119,214,38,225,105,20,99,85,33,12,125];

//TEST INPUT

function tinp(l){
	inp = new Uint8Array(l);
window.crypto.getRandomValues(inp);
}

//SWAP Function
function dswap(a){
	
	ix.unshift(ix.splice(a,1)[0]);	
}


//ENCODE

function encode(tes){
	var tm=Date.now(),
	inpi = Array.from(tes),
	count=128;
	inpi=inpi.concat(Array.from(window.crypto.getRandomValues(new Uint8Array(16))));
	
res = new Uint8Array(inpi.length);
ix=ixx.slice(0,256);
for (i in inpi){
	res[i]=ix.indexOf(inpi[i]);
	count=(count+res[i])&255;
	
	dswap(count);
	}
	
	ix=ixx2.slice(0,256);count=128;var i=res.length;
	while (i > -1){
	res[i]=ix.indexOf(res[i]);
	count=(count+res[i])&255;
	dswap(count);
	i--;
	}	

console.log((Date.now()-tm)/1000);
return res;}

//DECODE

function decode (inpi){
	
	var count=128,i=inpi.length;
	ret=new Uint8Array(inpi.length);
ix=ixx2.slice(0,256);
while (i > -1){
	count=(count+inpi[i])&255;
	ret[i]=ix[inpi[i]];
	
	dswap(count);
	i--;
	}	
	
	ix=ixx.slice(0,256);
	count=128;
	
	for (i in inpi){
	count=(count+ret[i])&255;
	ret[i]=ix[ret[i]];
	dswap(count);
	}
	return ret=ret.slice(0,ret.length-16);
}	
